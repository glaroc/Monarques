---
title: "Monarchs Sampling Design - Canada"
author: "Guillaume Larocque"
date: "17/02/2021"
output: html_document
---

```{r setup, eval=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## CREATING THE BASE LAYERS FROM CEC LAND COVER MAP
```{r, eval=FALSE}
library(rgrass7)

initGRASS('/usr/lib/grass74/',gisDbase = '/home/glaroc/Monarques/GRASS',location = 'CEC',mapset = 'PERMANENT',override = TRUE)

library(rgrass7)
initGRASS('/usr/lib/grass74/',gisDbase = '/home/ubuntu/data/GRASS',location = 'monarques',mapset = 'PERMANENT',override = TRUE)

##CREATION OF THE BASE LAND COVER LAYER WITH ROADS, RAILS AND TRANSMISSION LINES
execGRASS('r.in.gdal',input = '/home/glaroc/Monarques/Cartes_GIS/CEC_land_cover/CAN_NALCMS_2015_LC_30m_LAEA_mmu5pix_.tif',output = 'CEC', memory=10000)
execGRASS('g.region',raster='CEC')
execGRASS('v.in.ogr',input='/home/ubuntu/data/Monarques/Cartes_GIS/Roads/canada_hwy.shp', output= 'Roads', flags=c('overwrite'))
execGRASS('v.in.ogr',input='/home/ubuntu/data/Monarques/Cartes_GIS/Rail/canada_rails_cec.shp', output= 'Rails', flags=c('overwrite'))
execGRASS('v.in.ogr',input='/home/ubuntu/data/Monarques/Cartes_GIS/transmission_lines_OSM_CEC.gpkg', output= 'Transmission', flags=c('overwrite'))
execGRASS('v.in.ogr',input='/home/ubuntu/data/Monarques/Cartes_GIS/protected_areas_canada_qc.shp', output= 'Protected', snap='1e-09', flags=c('overwrite'))
execGRASS('v.to.rast',input= 'Roads',output = 'Roads', use='val',value=20, memory=150000, flags=c('overwrite'))
execGRASS('v.to.rast',input= 'Rails',output = 'Rails', use='val',value=21, memory=150000, flags=c('overwrite'))
execGRASS('v.to.rast',input= 'Transmission',output = 'Transmission', use='val',value=22, memory=150000, flags=c('overwrite'))
execGRASS('v.to.rast',input= 'Protected',output = 'Protected', use='val',value=100, memory=150000, flags=c('overwrite'))
execGRASS('r.patch',input='Roads, Rails, Transmission, CEC',output='CEC2', flags=c('overwrite'))
execGRASS('r.null',null=0,map='CEC2')
execGRASS('r.null',null=0,map='Protected')
execGRASS('r.mapcalc',expression='CEC_pa = CEC2+Protected', flags=c('overwrite'))
execGRASS('r.out.gdal', input='CEC_pa',output='/home/ubuntu/data/Monarques/cec_pa_lines.tif', format='GTiff',createopt="COMPRESS=DEFLATE")
##LAND COVER SUITABLE FOR MONARCHS
execGRASS('r.reclass', input = 'CEC_pa', output='CEC_suitable', rules='/home/ubuntu/data/Monarques/cec_reclass.txt', flags=c('overwrite'))
##EXTRACT LAND COVERS FOR EACH GTRS ZONE
execGRASS('v.in.ogr',input='/home/ubuntu/data/Monarques/canada_mastersample_in_range_poly_cec.shp', output='gtrs_10', flags=c('overwrite'))
execGRASS('v.to.rast',input='gtrs_10', output='CEC_suitable', use='attr',attribute_column='GTRS_ID',memory=150000, flags=c('overwrite'))
execGRASS('r.stats.zonal',base='gtrs_10', cover='CEC_suitable',method='sum',output='gtrs_suitable_zonal', flags=c('overwrite'))
execGRASS('r.out.gdal',input='gtrs_suitable_zonal',output='/home/ubuntu/data/Monarques/gtrs_suitable_zonal.tif', format='GTiff',createopt="COMPRESS=DEFLATE")
execGRASS('r.to.vec',input='gtrs_suitable_zonal', output='gtrs_suitable_zonal',type='area',column='suitable', flags=c('overwrite'))
execGRASS('v.out.ogr',input='gtrs_suitable_zonal', type='area',output='/home/ubuntu/data/Monarques/gtrs_suitable_zonal.gpkg')
```

### SELECTION OF GTRS SQUARES ZONES

gtrs_suitable_zonal file is opened in QGIS and a random identifier is given to each polygon. A random 5% of grid blocks are choosent. 

### 30 M SELECTION
```{r, eval=FALSE}
library(rgrass7)
library(stringr)
initGRASS('/usr/lib/grass74/',gisDbase = '/home/ubuntu/data/GRASS',location = 'monarques',mapset = 'PERMANENT',override = TRUE)

execGRASS('r.reclass',input='CEC_pa',output='CEC_5cats',rules='/home/ubuntu/data/Monarques/cec_reclass_5cats.txt',c('overwrite'))
fids=execGRASS('v.db.select',map='selected_blocks',columns='fid',flags=c("c","v"))
fids=attr(fids,"resOut")
ii=0
for (i in fids) {
  execGRASS('v.extract',input='selected_blocks',output='block_temp',where=paste0("fid=",i),flags = c('overwrite'))
  execGRASS('g.region', vector='block_temp')
  execGRASS('r.mask',vector='block_temp', flags = c("overwrite"))
  execGRASS('r.to.vect',input='CEC_5cats', output='temp', type='point',flags = c('overwrite'))
  for (j in (1:5)) {
    execGRASS('v.extract',input='temp', output='temp2', where=paste0("value=",j),flags = c('overwrite'))
    tt=execGRASS('v.info',map='temp2',flags=c('t'))
    npoints=as.numeric(str_replace(attr(tt,"resOut")[2],'points=',''))
    if(npoints > 1){
      npoints=min(npoints-1,20)
      execGRASS('v.extract',input='temp2', output='temp3', random=npoints, flags = c('overwrite'))
      if(i==fids[1] && j==1){
        execGRASS('v.patch',input='temp3', output='all30',flags = c('overwrite'))
      }else{
        execGRASS('v.patch',input='temp3', output='all30',flags = c('a','overwrite'))
      }
    }
  }
  ii=ii+1
  print(ii/length(fids))
}

#This doesn't quite work 
#execGRASS('r.mask',vector='block_temp', flags = c("overwrite"))
#execGRASS('v.db.addtable',map='all30')
#execGRASS('v.what.rast',map='all30',raster='CEC_pa',column='cover_type')
execGRASS('v.out.ogr', input='all30', type='point', output='/home/ubuntu/data/Monarques/all30.gpkg',flags=c('overwrite'))

```

### GENERATION OF FINAL MAP

Point sampling tool is used in QGIS to combine the province shapefile, the CEC_pa land cover and the GRTS block ids to the attribute table. 

Then, to generate point ID

```{r, eval=FALSE}

execGRASS('v.out.ogr', input='all30', type='point', output='/home/ubuntu/data/Monarques/all30_v2.csv',format='CSV',flags=c('overwrite'))
all30<-read.csv('/home/ubuntu/data/Monarques/all30_v2.csv')
for (i in unique(all30$block_id)) {
  all30[all30$block_id==i,'point_id'] <- seq(1,sum(all30$block_id==i))
}
all30$point_id_full=paste0('CA-',str_pad(all30$block_id,4,side='left',pad=0),'-',all30$point_id)

write.csv(all30,'all30_with_ids.csv')
```



